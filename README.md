# BlueSquare Assistant Chrome Extension

A Chrome extension that authenticates with BlueSquareApps via OAuth 2.0 and provides access to organization contacts through a side panel interface.

## Architecture

- **Chrome Extension (MV3)**: Side panel interface for user interaction
- **Backend**: Node.js + Express hosted on Vercel
- **Database**: Supabase for storing OAuth tokens (PassKey stored in plain text)
- **API**: BlueSquareApps endpoints at https://rc.bluesquareapps.com

## Setup Instructions

### 1. Database Setup (Supabase)

Create the following tables in your Supabase database:

```sql
-- OAuth sessions table
CREATE TABLE oauth_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL,
  state TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  used_at TIMESTAMPTZ
);

-- BSA tokens table (stores PassKey in plain text)
CREATE TABLE bsa_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL UNIQUE,
  passkey TEXT NOT NULL,          -- PassKey stored in plain text
  refresh_token TEXT,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes for better performance
CREATE INDEX idx_oauth_sessions_state ON oauth_sessions(state);
CREATE INDEX idx_oauth_sessions_session_id ON oauth_sessions(session_id);
CREATE INDEX idx_bsa_tokens_session_id ON bsa_tokens(session_id);
```

### 2. Backend Deployment (Vercel)

1. Install dependencies:
```bash
npm install
```

2. Set up environment variables in Vercel:
```
BSA_BASE=https://rc.bluesquareapps.com
BSA_CLIENT_ID=YOUR_BSA_CLIENT_ID
BSA_CLIENT_SECRET=YOUR_BSA_CLIENT_SECRET
BSA_REDIRECT_URI=YOUR_VERCEL_URL/auth/callback
SUPABASE_URL=YOUR_SUPABASE_URL
SUPABASE_SERVICE_ROLE_KEY=YOUR_SUPABASE_SERVICE_ROLE_KEY
APP_BASE_URL=YOUR_APP_BASE_URL
```

3. Deploy to Vercel:
```bash
vercel
```

### 3. Chrome Extension Installation

1. Generate icons:
   - Open `extension/icons/generate-icons.html` in a browser
   - Right-click each canvas and save as the corresponding PNG file

2. Load the extension in Chrome:
   - Open Chrome and navigate to `chrome://extensions/`
   - Enable "Developer mode"
   - Click "Load unpacked"
   - Select the `extension` directory

### 4. Local Development

For local development of the backend:

1. Create a `.env` file (copy from `.env.example`):
```bash
cp .env.example .env
```

2. Run the backend locally:
```bash
npm run dev
```

3. The extension will automatically use `http://localhost:3000` when loaded locally

## OAuth Flow

1. **Initiate**: Extension opens `/auth/start?session_id=...`
2. **Authorize**: Backend redirects to BlueSquareApps OAuth endpoint
3. **Callback**: Provider redirects back with authorization code
4. **Exchange**: Backend exchanges code for PassKey (access token)
5. **Store**: PassKey stored in plain text in Supabase
6. **Poll**: Extension polls `/auth/status` to detect completion
7. **Access**: Extension can now make API calls through backend

## API Endpoints

### Authentication
- `GET /auth/start?session_id=...` - Start OAuth flow
- `GET /auth/callback?code=...&state=...` - OAuth callback
- `GET /auth/status?session_id=...` - Check authentication status

### Data Access
- `GET /api/orgs?session_id=...` - List user organizations
- `POST /api/orgs/:orgId/contacts?session_id=...` - List contacts for organization

## Security Considerations

- **PassKey Storage**: The PassKey is stored in plain text in Supabase to be used directly in API calls
- **Access Control**: Use Supabase Row Level Security to protect the tokens table
- **Service Role**: Keep the service role key secure and never expose it to the client
- **Session Management**: Sessions are tied to unique IDs generated by the extension
- **HTTPS Only**: All communication happens over HTTPS

## Testing

1. Click the extension icon to open the side panel
2. Click "Login with BlueSquareApps"
3. Complete OAuth authentication in the popup window
4. Select an organization from the list
5. View contacts for the selected organization

## Project Structure

```
├── api/
│   └── index.js          # Express backend
├── extension/
│   ├── manifest.json     # Extension manifest
│   ├── background.js     # Service worker
│   ├── sidepanel.html    # Side panel UI
│   ├── sidepanel.js      # Side panel logic
│   ├── styles.css        # Styling
│   └── icons/           # Extension icons
├── package.json          # Node dependencies
├── vercel.json          # Vercel configuration
└── README.md            # This file
```

## Troubleshooting

### Extension not loading
- Ensure all icon files are present in `extension/icons/`
- Check for errors in `chrome://extensions/`

### Authentication fails
- Verify environment variables are set correctly in Vercel
- Check Supabase connection and table structure
- Ensure redirect URI matches exactly

### No data appearing
- Check browser console for errors
- Verify API endpoints are accessible
- Confirm PassKey is being stored correctly

## License

Private project - All rights reserved